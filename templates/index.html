<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EHI - Voice Assistant</title>
  <style>
    body {
      background: #0e0e0e;
      color: white;
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
      padding-top: 10%;
    }
    #response {
      margin-top: 2rem;
      font-size: 1.5rem;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
    }
    #mic {
      background: #444;
      color: white;
      border: none;
      padding: 1.2rem;
      border-radius: 50%;
      font-size: 2rem;
      cursor: pointer;
      margin-top: 2rem;
      box-shadow: 0 0 20px #0ff;
      transition: all 0.3s ease;
    }
    #mic:hover {
      background: #0ff;
      color: black;
      transform: scale(1.1);
    }
    #mic:disabled {
      background: #666;
      cursor: not-allowed;
      box-shadow: none;
    }
    .loading {
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body>
  <h1>üé§ Talk to EHI</h1>
  <p>Click the mic and speak. EHI will answer with voice.</p>
  <button id="mic">üéôÔ∏è</button>
  <div id="response">EHI is ready...</div>
  
  <script>
    const mic = document.getElementById("mic");
    const responseBox = document.getElementById("response");
    let isListening = false;
    let isProcessing = false;
    
    // Check if speech recognition is supported
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      responseBox.textContent = "‚ùå Speech recognition not supported in this browser.";
      mic.disabled = true;
    } else {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = "en-US";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.continuous = false;
      
      mic.onclick = () => {
        if (isListening || isProcessing) return;
        
        responseBox.textContent = "üéôÔ∏è Listening...";
        responseBox.classList.add("loading");
        mic.disabled = true;
        isListening = true;
        
        try {
          recognition.start();
        } catch (error) {
          console.error("Recognition start error:", error);
          resetUI();
          responseBox.textContent = "‚ùå Error starting speech recognition.";
        }
      };
      
      recognition.onresult = async (event) => {
        const msg = event.results[0][0].transcript;
        responseBox.textContent = `üó£Ô∏è You: ${msg}`;
        responseBox.classList.remove("loading");
        isListening = false;
        isProcessing = true;
        
        try {
          const res = await fetch("/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: msg })
          });
          
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }
          
          const data = await res.json();
          responseBox.textContent = `ü§ñ EHI: ${data.response}`;
          
          // Play voice using the Flask backend
          await playVoice(data.response);
          
        } catch (err) {
          console.error("Fetch failed:", err);
          responseBox.textContent = "‚ùå Error getting response. Check connection.";
        } finally {
          resetUI();
        }
      };
      
      recognition.onerror = (event) => {
        console.error("Recognition error:", event.error);
        let errorMsg = "‚ùå ";
        switch(event.error) {
          case 'no-speech':
            errorMsg += "No speech detected. Try again.";
            break;
          case 'audio-capture':
            errorMsg += "Microphone access denied.";
            break;
          case 'not-allowed':
            errorMsg += "Microphone permission denied.";
            break;
          case 'network':
            errorMsg += "Network error. Check connection.";
            break;
          default:
            errorMsg += "Speech recognition error. Try again.";
        }
        responseBox.textContent = errorMsg;
        resetUI();
      };
      
      recognition.onend = () => {
        if (isListening) {
          responseBox.textContent = "‚ùå Didn't catch that. Try again.";
          resetUI();
        }
      };
    }
    
    async function playVoice(text) {
      try {
        const response = await fetch("/speak", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: text })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `HTTP ${response.status}`);
        }
        
        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);
        const audio = new Audio(audioUrl);
        
        audio.onplay = () => {
          console.log("üîä EHI is speaking...");
          responseBox.classList.add("loading");
        };
        
        audio.onended = () => {
          console.log("üîá EHI finished speaking");
          responseBox.classList.remove("loading");
          URL.revokeObjectURL(audioUrl); // Clean up memory
        };
        
        audio.onerror = (e) => {
          console.error("Audio playback failed:", e);
          responseBox.classList.remove("loading");
          responseBox.textContent += " (Voice playback failed)";
          URL.revokeObjectURL(audioUrl);
        };
        
        await audio.play();
        
      } catch (error) {
        console.error("Voice synthesis error:", error);
        responseBox.textContent += " (Voice synthesis failed)";
      }
    }
    
    function resetUI() {
      isListening = false;
      isProcessing = false;
      mic.disabled = false;
      responseBox.classList.remove("loading");
    }
    
    // Request microphone permission on page load
    window.addEventListener('load', async () => {
      try {
        await navigator.mediaDevices.getUserMedia({ audio: true });
        console.log("Microphone permission granted");
      } catch (error) {
        console.warn("Microphone permission not granted:", error);
        responseBox.textContent = "‚ö†Ô∏è Please allow microphone access for voice input.";
      }
    });
  </script>
</body>
</html>
